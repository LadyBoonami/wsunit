#!/bin/bash

#TODO: test config, state

function unittest() {
	if [ ! -e "$WSUNIT_CONFIG/$1" ]; then
		echo "error: $1: unit not found" >&2
		exit 1
	fi
}

case "$1" in
	status)
		( cd "$WSUNIT_STATE/state" && grep -H "" * )
	;;

	graph)
		exec dot -Tx11 "$WSUNIT_STATE/state.dot"
	;;

	shutdown)
		pkill -F "$WSUNIT_STATE/wsunitd.pid" -TERM
	;;

	bump)
		pkill -F "$WSUNIT_STATE/wsunitd.pid" -USR1
	;;

	refresh)
		pkill -F "$WSUNIT_STATE/wsunitd.pid" -USR2
	;;

	"+w")
		unittest "$2"
		touch "$WSUNIT_STATE/wanted/$2"
	;;

	"-w")
		unittest "$2"
		rm "$WSUNIT_STATE/wanted/$2" 2>/dev/null || true
	;;

	"+m")
		unittest "$2"
		touch "$WSUNIT_STATE/masked/$2"
	;;

	"-m")
		unittest "$2"
		rm "$WSUNIT_STATE/masked/$2" 2>/dev/null || true
	;;

	"+d")
		unittest "$2"
		unittest "$3"
		mkdir -p "$WSUNIT_CONFIG/$2/deps"
		touch "$WSUNIT_CONFIG/$2/deps/$3"
	;;

	"-d")
		unittest "$2"
		unittest "$3"
		rm "$WSUNIT_CONFIG/$2/deps/$3" 2>/dev/null || true
	;;

	"+r")
		unittest "$2"
		unittest "$3"
		mkdir -p "$WSUNIT_CONFIG/$2/revdeps"
		touch "$WSUNIT_CONFIG/$2/revdeps/$3"
	;;

	"-r")
		unittest "$2"
		unittest "$3"
		rm "$WSUNIT_CONFIG/$2/revdeps/$3" 2>/dev/null || true
	;;

	*)
		# TODO
		exit 1
	;;
esac
